name: Docker Build, Push, and Notify

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: ğŸ³ Build & Push Frontend
        working-directory: ./frontend
        run: |
          docker build -t masroorahmed/whatsapp-frontend:latest .
          docker push masroorahmed/whatsapp-frontend:latest

      - name: ğŸ³ Build & Push Backend
        working-directory: ./backend
        run: |
          docker build -t masroorahmed/whatsapp-backend:latest .
          docker push masroorahmed/whatsapp-backend:latest

      - name: ğŸ“¢ Send Deployment Notification
        if: always() # Runs even if previous steps fail
        run: |
          # Determine deployment status
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="âœ… SUCCESS"
            EMOJI="ğŸš€"
          else
            STATUS="âŒ FAILED"
            EMOJI="ğŸ”¥"
          fi

          # Prepare notification payload
          curl -X POST "https://gpzm41gnvh.execute-api.us-east-1.amazonaws.com/security-cis" \
            -H "Content-Type: application/json" \
            -d '{
              "message": "$EMOJI Docker Deployment - $STATUS",
              "details": {
                "frontend": "masroorahmed/whatsapp-frontend:latest",
                "backend": "masroorahmed/whatsapp-backend:latest",
                "status": "$STATUS",
                "time": "$(date -u)",
                "commit": "${{ github.sha }}",
                "workflow_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            }'
